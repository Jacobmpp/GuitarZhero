<html>
<head>
<style>
*{padding: 0; margin:0;}
canvas{ background: #eee; display: block; margin: 0 auto;}
</style>
<script src="jquery-3.3.1.js"></script>
</head>

<body>
<canvas id= "myCanvas" width="1280" height="720"></canvas>
<script type="text/javascript">
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
document.addEventListener("keydown", keyDownHandler, false);
document.addEventListener("keyup", keyUpHandler, false);
canvas.addEventListener("mousedown", getPosition, false);
canvas.addEventListener("mouseup", getPosition2, false);

var x = 0;
var y = 0;
var mouseIsDown = false;

var lP = false;
var rP = false;
var uP = false;
var gameTime = 0;
var lastRender = 0;
//green red yellow blue orange
var greenButton = false;
var redButton = false;
var yellowButton = false;
var blueButton = false;
var orangeButton = false;
var strum = false;
var audio = new Audio('guitar.ogg');
var songPlaying = false;
var getSong = true;
var song_notes;
var song_notes2;
var isLoading = true;




var notes = [];

function Note(t1, t2, b, l){
	this.time = t1;
	this.type = t2;
	this.button = b;
	this.length = l;
	this.y = 0;
}

for(var i = 0; i < 50; i++)
{
var time = i * 50;
var button = i%6;

	notes[i] = new Note(time, "N", button, 0);
}

function drawNotes(progress){
	for(var i = 0; i < notes.length; i++)
	{
	
	
		if(notes[i].time <= gameTime && gameTime <= notes[i].time + 5000)
		{
		var per = ((gameTime - notes[i].time)/5000);
		var y = (per * 100) + (per * per * 400)  + 45;
		
		if(notes[i].button == 0)
		{
			var x = y/-3.093;
			ctx.beginPath();
			ctx.fillStyle = "green";
			ctx.strokeStyle = "green";
			ctx.ellipse(x+600, y, 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), Math.PI / 2, 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();
			
			if(gameTime >= notes[i].time + 4700 && gameTime <= notes[i].time + 5300)
			{
				if(greenButton && strum)
				{
					console.log("Congrats dude");
				}
			}
		}
		if(notes[i].button == 1)
		{
			var x = y/-6.19;
			ctx.beginPath();
			ctx.fillStyle = "red";
			ctx.strokeStyle = "red";
			ctx.ellipse(x+620, y, 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), Math.PI / 2, 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();
			
			if(gameTime >= notes[i].time + 4700 && gameTime <= notes[i].time + 5300)
			{
				if(redButton && strum)
				{
					console.log("Congrats dude");
				}
			}
		}
		if(notes[i].button == 2)
		{
			var x = 640;
			ctx.beginPath();
			ctx.fillStyle = "yellow";
			ctx.strokeStyle = "yellow";
			ctx.ellipse(x, y, 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), Math.PI / 2, 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();
			
			if(gameTime >= notes[i].time + 4700 && gameTime <= notes[i].time + 5300)
			{
				if(yellowButton && strum)
				{
					console.log("Congrats dude");
				}
			}
		}
		if(notes[i].button == 3)
		{
			var x = y/6.19;
			ctx.beginPath();
			ctx.fillStyle = "blue";
			ctx.strokeStyle = "blue";
			ctx.ellipse(x+660, y, 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), Math.PI / 2, 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();
			
			if(gameTime >= notes[i].time + 4700 && gameTime <= notes[i].time + 5300)
			{
				if(blueButton && strum)
				{
					console.log("Congrats dude");
				}
			}
		}
		if(notes[i].button == 4)
		{
			var x = y/3.093;
			ctx.beginPath();
			ctx.fillStyle = "orange";
			ctx.strokeStyle = "orange";
			ctx.ellipse(x+680, y, 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), 3.75 + ( 11.25 * (gameTime - notes[i].time)/5000), Math.PI / 2, 0, 2 * Math.PI);
			ctx.fill();
			ctx.stroke();
			
			if(gameTime >= notes[i].time + 4700 && gameTime <= notes[i].time + 5300)
			{
				if(orangeButton && strum)
				{
					console.log("Congrats dude");
				}
			}
		}
	}
	}
}

function getPosition2(event){
	mouseIsDown = false;
}

function getPosition(event)
{
  x = event.x - canvas.offsetLeft;
  y = event.y - canvas.offsetTop;
	mouseIsDown = true;
	console.log("Mouse is pressed");
  //alert("x:" + x + " y:" + y);
}

function keyDownHandler(e){
if(e.keyCode == 65){
//A key
greenButton = true;
}
if(e.keyCode == 83)
{
//S key
redButton = true;
}
if(e.keyCode == 68)
{
//D key
yellowButton = true;
}
if(e.keyCode == 70)
{
//F key
blueButton = true;
}
if(e.keyCode == 32)
{
//Space bar
orangeButton = true;
}
if(e.keyCode == 75)
{
//K key
strum = true;
}
if(e.keyCode == 76)
{
//L Key
strum = true;
}		
}


function keyUpHandler(e){
if(e.keyCode == 65){
//A key
greenButton = false;
}
if(e.keyCode == 83)
{
//S key
redButton = false;
}
if(e.keyCode == 68)
{
//D key
yellowButton = false;
}
if(e.keyCode == 70)
{
//F key
blueButton = false;
}
if(e.keyCode == 32)
{
//Space bar
orangeButton = false;
}
if(e.keyCode == 75)
{
//K key
strum = false;
}
if(e.keyCode == 76)
{
//L Key
strum = false;
}
}

function drawNeck()
{
line(560   ,45 ,320   ,540);
line(720   ,45 ,960   ,540);
line(560   ,45 ,720   ,45 );
line(960   ,540,320   ,540);
line(586.66,45 ,426.66,540);
line(613.33,45 ,533.33,540);
line(640   ,45 ,640   ,540);
line(666.66,45 ,746.66,540);
line(693.33,45 ,853.33,540);
ctx.beginPath();
if(greenButton)
{
ctx.fillStyle = "green";
}
else
{
ctx.fillStyle = "#eee";
}
ctx.strokeStyle = "green";
ctx.ellipse(426.6, 540, 15, 15, Math.PI / 2, 0, 2 * Math.PI);
ctx.fill();
ctx.stroke();
ctx.beginPath();
if(redButton)
{
ctx.fillStyle = "red";
}
else
{
ctx.fillStyle = "#eee";
}
ctx.strokeStyle = "red";
ctx.ellipse(533.3, 540, 15, 15, Math.PI / 2, 0, 2 * Math.PI);
ctx.fill();
ctx.stroke();
ctx.beginPath();
if(yellowButton)
{
ctx.fillStyle = "yellow";
}
else
{
ctx.fillStyle = "#eee";
}
ctx.strokeStyle = "yellow";
ctx.ellipse(640, 540, 15, 15, Math.PI / 2, 0, 2 * Math.PI);
ctx.fill();
ctx.stroke();
ctx.beginPath();
if(blueButton)
{
ctx.fillStyle = "blue";
}
else
{
ctx.fillStyle = "#eee";
}
ctx.strokeStyle = "blue";
ctx.ellipse(746.6, 540, 15, 15, Math.PI / 2, 0, 2 * Math.PI);
ctx.fill();
ctx.stroke();
ctx.beginPath();
if(orangeButton)
{
ctx.fillStyle = "orange";
}
else
{
ctx.fillStyle = "#eee";
}
ctx.strokeStyle = "orange";
ctx.ellipse(853.3, 540, 15, 15, Math.PI / 2, 0, 2 * Math.PI);
ctx.fill();
ctx.stroke();

}
function line(x1, y1, x2, y2, col = "black")
{
ctx.beginPath();
ctx.strokeStyle = col;
ctx.moveTo(x1, y1);
ctx.lineTo(x2, y2);
ctx.stroke();
ctx.closePath();
}
function rect(x, y, w, h, col = "black") 
{
ctx.beginPath();
ctx.fillStyle = col;
ctx.fillRect(x, y, w, h);
ctx.fill();
ctx.closePath();	
}
function circle(x, y, r, col = "black", stroke = "NoStroke") 
{
ctx.beginPath();
ctx.ellipse(x, y, r, r, 7, 0, 7);
ctx.fillStyle = col; 
if(stroke != "NoStroke"){
ctx.strokeStyle = stroke;
ctx.stroke();
}
ctx.fill();
ctx.closePath();	
}

function loadingScreen(){
if(getSong)
{
	song_notes= new JSONArray("notes.json");	
	getSong = false;
}
	ctx.clearRect(0, 0 , 1200, 1200);
	ctx.fillText("Guitar Zhero", 100, 100);
	////ctx.fillStyle = "red";
	if(mouseIsDown)
	{
		ctx.fillStyle = "red";
		ctx.beginPath();
		ctx.rect(250, 250, 200,200);
		ctx.fill();
		ctx.fillStyle = "black";
		ctx.beginPath();
		ctx.rect(270, 270, 160,160);
		ctx.fill();
		isLoading = false;
	}
	else{
		ctx.fillStyle = "red";
		ctx.fillRect(250, 250, 200,200);
	}
	if(!isLoading)
	{
	ctx.clearRect(0,0,1200,1400);
	requestAnimationFrame(draw);
	}
	else
	{
	requestAnimationFrame(loadingScreen);
	}
	}

function draw(timestamp)
{
if(!songPlaying)
{
	audio.play();
	console.log("A song should be playing");
	songPlaying = true;
}



console.log("This should be song_notes" + song_notes[0]);


for( var i = 0; i < song_notes.noteTimes.note.length; i++)
{
	console.log(song_notes.noteTimes.note[i].time);
	if(song_notes.noteTimes[i].time > gameTime - 7000)
	{
		new Note(song_notes.noteTimes[i].time, "N", song_notes.noteTimes[i].button, song_notes.noteTimes[i].length);
		notes.push(new Note(song_notes.noteTimes.note[i].time, "N", song_notes.noteTimes.note[i].button, song_notes.noteTimes.note[i].length));
		console.log("Added a note to notes");
	}
}

ctx.clearRect(0,0,1400,1000);
var progress = timestamp - lastRender;
drawNeck();
drawNotes(progress);
gameTime += progress;
lastRender = timestamp;
requestAnimationFrame(draw);
}

if(isLoading)
{
///load screen
requestAnimationFrame(loadingScreen);
}
else
{
///Game time
requestAnimationFrame(draw);
}

//setInterval(draw,1);

//draw();

</script>
</body>
</html>
